import time
import threading
import gateway
import sys, os
import nodes


def main():
    while True:
        time.sleep(1)
        try:
            print("Try to init Gateway ...")
            gate = gateway.Gateway()    
            gate.bus.start_notifier()
            break
        except:
            print("ERROR:", sys.exc_info()[1])

    gate.startGateway()
    while True:
        try:
            if nodes.init_301(gate.bus.elrest3) == (True , "OK"):
                print("Found CANopen Network")
                break
            else :
                print("Searching CANopen Network ...")
                time.sleep(1)
        except:
            print("ERROR:", sys.exc_info()[1])
    
    try:
        print("Starting up Gateway")

        timer = time.time()
        while True:
            gate.processCAN()
        
            # wenn ruhe ist von der dSpace
            # Status von CANopen an dSpace mit CAN
            if time.time() - timer > 0.005 :
                timer = time.time()
                gate.get_status()
    except:
        print("ERROR:", sys.exc_info()[1])


if __name__ == "__main__" :
    main()