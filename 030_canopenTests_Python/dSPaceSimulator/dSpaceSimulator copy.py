import time

import cantools
from pprint import pprint

import sys, os
pathname = os.path.dirname(sys.argv[0])   

from tkinter import *
from functools import partial

from initNI import NIXnet
import six


ch1 = NIXnet('CAN3', 500000)


class DSpaceSim():
    def __init__(self):
        self.root = Tk()
        self.display_text = StringVar()

        self.topframe = Frame(self.root, padx=20, pady=20)
        self.topframe.pack()
        self.bottomframe = Frame(self.root, padx=20, pady=20 , highlightbackground="red", highlightthickness=1)
        self.bottomframe.pack(side=BOTTOM, fill=X)

        self.db = cantools.database.load_file(pathname + '/dbcs/ADrive.dbc')

        for i, message in enumerate(self.db.messages):
            Label(self.topframe, text='0x%x' % message.frame_id).grid(row=i, column=0, sticky=NW)
            Label(self.topframe, text=message.name).grid(row=i, column=1, sticky=NW)

            
            sig_frame = Frame(self.topframe, highlightbackground="black", highlightthickness=1, padx=5, pady=5)
            sig_frame.grid(row=i, column=2)
            
            e_list = []
            for signal in message.signals:
                Label(sig_frame, text=signal.name).pack(anchor=W)
                e = Entry(sig_frame)
                if signal.name == 'data_type': 
                    e.insert(END, 4)
                else:
                    e.insert(END, 0)
                e.pack()
                e_list.append(e)

            bSend = Button( self.topframe,
                            text='Send',
                            fg='red',
                            command=partial(self.sendMsg, message, e_list, self.db) )
            bSend.grid(row=i, column=3, sticky=NW)

            bSend = Button( self.topframe,
                            text='Read',
                            fg='green',
                            command=partial(self.sendMsg, message, e_list, self.db) )
            bSend.grid(row=i, column=4, sticky=NW)


        self.monitor = Label(self.bottomframe, text="CAN RX")
        self.monitor.pack(anchor=W)
        self.monitor = Label(self.bottomframe, text="...", textvariable=self.display_text)
        self.monitor.pack(anchor=W)

        self.monitor.after(100, self.readMsg)

        self.root.mainloop()


    def sendMsg(self, msg, e_list, db):
        signal_dict = {}
        for i, e in enumerate(e_list):
            signal_dict[msg.signals[i].name] = float(e.get())

        out = db.get_message_by_name(msg.name)
        payload = out.encode(signal_dict)

        ch1.writeFrame(out.frame_id, payload)


    def readMsg(self):
        incoming = ch1.readFrame()
        if incoming:
            o = ""
            o += str(incoming.identifier)
            o += str(list(six.iterbytes(incoming.payload)))
            self.display_text.set(o)

        self.monitor.after(100, self.readMsg)


_ = DSpaceSim()